steps:
# Step 1: Run application tests (Recommended)
# - name: 'eclipse-temurin:24-jdk'
#   id: 'Run Tests'
#   entrypoint: 'bash'
#   args:
#     - '-c'
#     - |
#       apt-get update && apt-get install -y maven
#       mvn test

# Step 2: Build the container image
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Docker Image'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/reto-tecnico-app:$SHORT_SHA', '.']

# Step 3: Push the image to Artifact Registry
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push to Artifact Registry'
  args: ['push', 'gcr.io/$PROJECT_ID/reto-tecnico-app:$SHORT_SHA']

# Step 4: Deploy to Cloud Run
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'Deploy to Cloud Run'
  entrypoint: 'gcloud'
  args:
    - 'run'
    - 'deploy'
    - 'farmatodo-reto-tecnico'
    - '--image=gcr.io/$PROJECT_ID/reto-tecnico-app:$SHORT_SHA'
    - '--region=us-south1'
    - '--platform=managed'
    - '--service-account=your-runtime-sa@$PROJECT_ID.iam.gserviceaccount.com'

    # --- CHealth Check / Startup Probe Configuration ---
    - '--startup-probe=initialDelaySeconds=30,periodSeconds=10,timeoutSeconds=5,failureThreshold=3,httpGet.path=/ping'

    # --- Non-Sensitive Environment Variables ---
    - '--set-env-vars=TOKENIZATION_REJECTION_PROBABILITY=0.1,PAYMENT_REJECTION_PROBABILITY=0.25,PAYMENT_PROCESS_MAX_RETRIES=3'

    # --- Sensitive Environment Variables (from Secret Manager) ---
    - '--set-secrets=HMAC_SECRET_KEY=hmac-secret:latest,AES_SECRET_KEY=aes-secret:latest,EMAIL_SENDER_ADDRESS=email-sender-address:latest,MAILTRAP_USERNAME=mailtrap-username:latest,MAILTRAP_PASSWORD=mailtrap-password:latest,EMAIL_APP_PASSWORD=email-app-password:latest,EMAIL_SENDER_ALIAS=email-sender-alias:latest'

# Required by Cloud Build to list the built image.
images:
- 'gcr.io/$PROJECT_ID/reto-tecnico-app:$SHORT_SHA'

# --- Build Options ---
options:
  logging: CLOUD_LOGGING_ONLY